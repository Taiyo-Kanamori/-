<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>徹夜対策アプリ</title>
    <script src="kanamori.js" defer></script>
    <link rel="stylesheet" href="kanamori.css" />
    <style>
      /* モーダルのスタイル */
      .modal {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          padding: 20px;
          z-index: 10000;
          box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
          display: none;
      }
      /* 背景の暗いオーバーレイ */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 9999;
          display: none;
      }
      .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            color: white;
            display: none;
            cursor: none; /* カーソルを非表示にする */
        }
    </style>
  </head>
  
  <body>
    <div id="modal-overlay" class="modal-overlay"></div>
    <div id="modal" class="modal"></div>
    <div id="overlay" class="overlay"></div>
  
    <header>
      <h1>のこり時間</h1>
      <h1 id="dif-time"></h1>
      現在時刻　<span id="current-time"></span><br />
      設定時間<input type="time" id="set-time" />
      <button onclick="differencetime()">決定</button>
      <button onclick="fullscreen()">全画面</button>
      <button id="recordtime">時間を記録</button>
      <button id="load-times">記録された時間を表示</button>
  
      <h2>Wake Times</h2>
      <ul id="wake-times"></ul>
      
      <h2>Sleep Times</h2>
      <ul id="sleep-times"></ul>
  
      <div id="response"></div>
  
      <script>
        function fullscreen(){
          //全画面表示
          console.log("fullscreen");
          document.getElementById('modal-overlay').style.display = 'block';
          document.getElementById('modal').style.display = 'block';
          document.getElementById('overlay').style.display = 'block';
        }
        
        function updateTime() {
          //現在時刻表示
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          const seconds = String(now.getSeconds()).padStart(2, '0');
          document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
        }
        updateTime();
        setInterval(updateTime, 1000);
  
        let settotalseconds = null;
        let difseconds;
        function differencetime(){
          //決定ボタンを押されたとき設定時間の変更
          let settime = document.getElementById('set-time').value;
          if (settime){
            let [sethours, setminutes] = settime.split(':').map(Number);
            settotalseconds = sethours*3600+setminutes*60;
          }
          else{
            settotalseconds = null;
          }
        }
  
        function diftime() {
          //残り時間の計算、表示
          let now = new Date();
          let hours = now.getHours();
          let minutes = now.getMinutes();
          let seconds = now.getSeconds();
          let difhours,difminutes;
          if (settotalseconds === null){
            difhours = "--";
            difminutes = "--";
            difseconds = "--";
          }
          else{
            let totalseconds = hours*3600+minutes*60+seconds;
            difseconds = settotalseconds - totalseconds;
            if (difseconds < 0){
              difseconds += 24*3600;
            }
            difhours = Math.floor(difseconds / 3600);
            difseconds %= 3600;
            difminutes = Math.floor(difseconds / 60);
            difseconds %= 60;
            difhours = String(difhours).padStart(2, '0');
            difminutes = String(difminutes).padStart(2, '0');
            difseconds = String(difseconds).padStart(2, '0');
          }
          document.getElementById('dif-time').textContent = `${difhours}:${difminutes}:${difseconds}`;
          
          if (difhours === "00" & difminutes ==="00" & difseconds ==="00"){
            console.log("test");
            alert("時間が経過しました");
            
            fullscreen();
          }
        }
        setInterval(diftime, 1000);
  
        async function recordTime(type) {
            const currentTime = new Date().toISOString();
            try {
              const response = await fetch('/record-time', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ type, time: currentTime })
              });
  
              if (response.ok) {
                  const data = await response.json();
                  document.getElementById('response').innerText = data.message;
              } else {
                  document.getElementById('response').innerText = 'エラーが発生しました。';
              }
            } catch (error) {
              console.error('Error recording time:', error);
            }
        }
  
        document.getElementById('recordtime').addEventListener('click', () => {
            recordTime('wake');
        });
  
        document.getElementById('load-times').addEventListener('click', async () => {
          try {
            const response = await fetch('/get-times');
            if (response.ok) {
              const data = await response.json();
              const wakeTimesList = document.getElementById('wake-times');
              const sleepTimesList = document.getElementById('sleep-times');
  
              wakeTimesList.innerHTML = '';
              sleepTimesList.innerHTML = '';
  
              data.wakeTimes.forEach(time => {
                const li = document.createElement('li');
                li.textContent = time;
                wakeTimesList.appendChild(li);
              });
  
              data.sleepTimes.forEach(time => {
                const li = document.createElement('li');
                li.textContent = time;
                sleepTimesList.appendChild(li);
              });
  
            } else {
              console.error('Failed to load times');
            }
          } catch (error) {
            console.error('Error fetching times:', error);
          }
        });
  
      </script>
    </header>

    <!--
    <aside id="left">
      <p>左カラム</p>
    </aside>-->
    <main>
      <div id="response"></div>
      <button id="kiroku-button">記録</button>
      <p>アチーブメント</p>
    </main>
    <!--<aside id="right">
      <p>ランキング</p>
    </aside>-->
    <footer>
      <p>フッター</p>
    </footer>
  </body>
</html>
